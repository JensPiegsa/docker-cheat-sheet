<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Docker Cheat Sheet by JensPiegsa</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">Docker Cheat Sheet</h1>
      <h2 class="project-tagline">Find, Copy and Paste, Anywhere.</h2>
      <a href="https://github.com/JensPiegsa/docker-cheat-sheet" class="btn">View on GitHub</a>
      <a href="https://github.com/JensPiegsa/docker-cheat-sheet/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/JensPiegsa/docker-cheat-sheet/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <p><a href="https://www.paypal.com/cgi-bin/webscr?cmd=_s-xclick&amp;hosted_button_id=WZJTZ3V8KKARC"><img src="https://img.shields.io/badge/Donate-PayPal-blue.svg" alt="Donate"></a>
<a href="https://github.com/JensPiegsa/docker-cheat-sheet/edit/master/README.md#fork-destination-box"><img src="https://img.shields.io/github/forks/badges/shields.svg?style=flat&amp;label=Fork%20on%20GitHub&amp;color=blue" alt="Fork on GitHub"></a>
<a href="https://github.com/JensPiegsa/docker-cheat-sheet/issues"><img src="https://img.shields.io/github/issues-raw/badges/shields.svg?style=flat&amp;label=Comments%2FIssues" alt="Issues"></a></p>

<p>This document is hosted at <a href="http://docker.jens-piegsa.com/">docker.jens-piegsa.com</a>.</p>

<h1>
<a id="content" class="anchor" href="#content" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Content</h1>

<ul>
<li>
<a href="#1-fundamentals">1. Fundamentals</a>

<ul>
<li><a href="#11-concepts">1.1. Concepts</a></li>
<li><a href="#12-lifecycle">1.2. Lifecycle</a></li>
</ul>
</li>
<li>
<a href="#2-recipes">2. Recipes</a>

<ul>
<li>
<a href="#21-docker-engine">2.1. Docker Engine</a>

<ul>
<li><a href="#211-building-images">2.1.1. Building Images</a></li>
<li><a href="#212-running-containers">2.1.2. Running Containers</a></li>
<li><a href="#213-using-volumes">2.1.3. Using Volumes</a></li>
</ul>
</li>
<li><a href="#22-docker-machine">2.2. Docker Machine</a></li>
<li><a href="#23-dockerfile">2.3. Dockerfile</a></li>
</ul>
</li>
<li>
<a href="#3-showcases">3. Showcases</a>

<ul>
<li><a href="#31-private-docker-registry">3.1. Private Docker Registry</a></li>
<li><a href="#32-continuous-integration-tool-stack">3.2. Continuous Integration Tool Stack</a></li>
</ul>
</li>
<li><a href="#4-best-practices">4. Best Practices</a></li>
<li><a href="#5-additional-material">5. Additional Material</a></li>
</ul>

<h1>
<a id="1-fundamentals" class="anchor" href="#1-fundamentals" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>1. Fundamentals</h1>

<h1>
<a id="11-concepts" class="anchor" href="#11-concepts" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>1.1. Concepts</h1>

<ul>
<li>
<strong>Union file system (UFS)</strong>: allows to overlay multiple file systems appearing as a single system whereby equal folders are merged and equally named files hide their previous versions</li>
<li>
<strong>Image</strong>: a portable read-only file system layer optionally stacked on a parent image</li>
<li>
<strong>Dockerfile</strong>: used to <code>build</code> an image and declare the command executed in the container</li>
<li>
<strong>Registry</strong>: is the place where to <code>push</code> and <code>pull</code> from named / tagged images </li>
<li>
<strong>Container</strong>: an instance of an image with a writable file system layer on top, virtual networking, ready to execute a single application </li>
<li>
<strong>Volume</strong>: a directory outside the UFS that can be mounted inside containers for persistent and shared data </li>
<li>
<strong>Network</strong>: acts as a namespace for containers</li>
<li>
<strong>Service</strong>: a flexible number of container replicas running on a cluster of multiple hosts</li>
</ul>

<h1>
<a id="12-lifecycle" class="anchor" href="#12-lifecycle" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>1.2. Lifecycle</h1>

<p><em>A typical <code>docker</code> workflow:</em></p>

<ul>
<li>
<code>build</code> an image based on a <code>Dockerfile</code>
</li>
<li>
<code>tag</code> and <code>push</code> the image to a <em>registry</em>
</li>
<li>
<code>login</code> to the registry from the runtime environment to <code>pull</code> the image</li>
<li>optionally <code>create</code> a <code>volume</code> or two to provide configuration files and hold data that needs to be persisted </li>
<li>
<code>run</code> a container based on the image</li>
<li>
<code>stop</code> and <code>start</code> the container if necessary</li>
<li>
<code>commit</code> the container to turn it into an image</li>
<li>in exceptional situations, <code>exec</code> additional commands inside the container</li>
<li>to replace a container with an updated version 

<ul>
<li>
<code>pull</code> the new image from the registry</li>
<li>
<code>stop</code> the running container</li>
<li>backup your volumes to be prepared for a potential rollback</li>
<li>
<code>run</code> the newer one by specifying a temporary name</li>
<li>if successful, <code>remove</code> the old container and <code>rename</code> the new one accordingly</li>
</ul>
</li>
</ul>

<h1>
<a id="2-recipes" class="anchor" href="#2-recipes" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>2. Recipes</h1>

<h2>
<a id="21-docker-engine" class="anchor" href="#21-docker-engine" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>2.1. Docker Engine</h2>

<h3>
<a id="211-building-images" class="anchor" href="#211-building-images" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>2.1.1. Building Images</h3>

<h4>
<a id="debug-image-build" class="anchor" href="#debug-image-build" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Debug image build</h4>

<ul>
<li>
<code>docker build</code> shows the IDs of all temporary containers and intermediate images</li>
<li>use <code>docker run -it IMAGE_ID</code> with the ID of the image resulting from the last successful build step and try the next command manually</li>
</ul>

<h3>
<a id="212-running-containers" class="anchor" href="#212-running-containers" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>2.1.2. Running Containers</h3>

<h4>
<a id="start-container-and-run-command-inside" class="anchor" href="#start-container-and-run-command-inside" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Start container and run command inside</h4>

<div class="highlight highlight-source-shell"><pre>docker run -it ubuntu:14.04 /bin/bash</pre></div>

<h4>
<a id="start-a-shell-in-a-running-container" class="anchor" href="#start-a-shell-in-a-running-container" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Start a shell in a running container</h4>

<div class="highlight highlight-source-shell"><pre>docker <span class="pl-c1">exec</span> -it CONTAINER /bin/bash</pre></div>

<h4>
<a id="start-a-container-as-another-user" class="anchor" href="#start-a-container-as-another-user" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Start a container as another user</h4>

<div class="highlight highlight-source-shell"><pre>docker run -u root IMAGE</pre></div>

<h4>
<a id="list-all-existing-containers" class="anchor" href="#list-all-existing-containers" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>List all existing containers</h4>

<div class="highlight highlight-source-shell"><pre>docker ps -a</pre></div>

<h4>
<a id="list-running-processes-inside-a-container" class="anchor" href="#list-running-processes-inside-a-container" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>List running processes inside a container</h4>

<div class="highlight highlight-source-shell"><pre>docker top CONTAINER</pre></div>

<h4>
<a id="follow-the-logs" class="anchor" href="#follow-the-logs" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Follow the logs</h4>

<div class="highlight highlight-source-shell"><pre>docker -f --tail=1000 CONTAINER</pre></div>

<h4>
<a id="stop-all-running-containers" class="anchor" href="#stop-all-running-containers" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Stop all running containers</h4>

<div class="highlight highlight-source-shell"><pre>docker stop <span class="pl-s"><span class="pl-pds">$(</span>docker ps -q<span class="pl-pds">)</span></span></pre></div>

<h4>
<a id="remove-all-stopped-containers-except-those-suffixed--data" class="anchor" href="#remove-all-stopped-containers-except-those-suffixed--data" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Remove all stopped containers, except those suffixed '-data':</h4>

<div class="highlight highlight-source-shell"><pre>docker ps -a -f status=exited <span class="pl-k">|</span> grep -v <span class="pl-s"><span class="pl-pds">'</span>\-data *$<span class="pl-pds">'</span></span><span class="pl-k">|</span> awk <span class="pl-s"><span class="pl-pds">'</span>{if(NR&gt;1) print $1}<span class="pl-pds">'</span></span> <span class="pl-k">|</span> xargs -r docker rm</pre></div>

<h4>
<a id="remove-all-stopped-containers-warning-removes-data-only-containers-too" class="anchor" href="#remove-all-stopped-containers-warning-removes-data-only-containers-too" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Remove all stopped containers (warning: removes data-only containers too)</h4>

<div class="highlight highlight-source-shell"><pre>docker rm <span class="pl-s"><span class="pl-pds">$(</span>docker ps -qa -f status=exited<span class="pl-pds">)</span></span></pre></div>

<ul>
<li><em>note: the filter flag <code>-f status=exited</code> may be omitted here since running containers can not be removed</em></li>
</ul>

<h4>
<a id="list-all-images" class="anchor" href="#list-all-images" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>List all images</h4>

<div class="highlight highlight-source-shell"><pre>docker images -a</pre></div>

<h4>
<a id="remove-all-unused-images" class="anchor" href="#remove-all-unused-images" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Remove all unused images</h4>

<div class="highlight highlight-source-shell"><pre>docker rmi <span class="pl-s"><span class="pl-pds">$(</span>docker images -qa -f dangling=<span class="pl-c1">true</span><span class="pl-pds">)</span></span></pre></div>

<h4>
<a id="show-image-history-of-container" class="anchor" href="#show-image-history-of-container" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Show image history of container</h4>

<div class="highlight highlight-source-shell"><pre>docker <span class="pl-c1">history</span> --no-trunc=<span class="pl-c1">true</span> <span class="pl-s"><span class="pl-pds">$(</span>docker inspect -f <span class="pl-s"><span class="pl-pds">'</span>{{.Image}}<span class="pl-pds">'</span></span> CONTAINER<span class="pl-pds">)</span></span></pre></div>

<h4>
<a id="show-file-system-changes-compared-to-the-original-image" class="anchor" href="#show-file-system-changes-compared-to-the-original-image" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Show file system changes compared to the original image</h4>

<div class="highlight highlight-source-shell"><pre>docker diff CONTAINER</pre></div>

<h4>
<a id="backup-volume-to-host-directory" class="anchor" href="#backup-volume-to-host-directory" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Backup volume to host directory</h4>

<div class="highlight highlight-source-shell"><pre>docker run -rm --volumes-from SOURCE_CONTAINER -v <span class="pl-s"><span class="pl-pds">$(</span><span class="pl-c1">pwd</span><span class="pl-pds">)</span></span>:/backup busybox \
 tar cvf /backup/backup.tar /data</pre></div>

<h4>
<a id="restore-volume-from-host-directory" class="anchor" href="#restore-volume-from-host-directory" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Restore volume from host directory</h4>

<div class="highlight highlight-source-shell"><pre>docker run -rm --volumes-from TARGET_CONTAINER -v <span class="pl-s"><span class="pl-pds">$(</span><span class="pl-c1">pwd</span><span class="pl-pds">)</span></span>:/backup busybox tar xvf /backup/backup.tar</pre></div>

<h4>
<a id="show-volumes" class="anchor" href="#show-volumes" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Show volumes</h4>

<div class="highlight highlight-source-shell"><pre>docker inspect -f <span class="pl-s"><span class="pl-pds">'</span>{{range $v, $h := .Config.Volumes}}{{$v}}{{end}}<span class="pl-pds">'</span></span> CONTAINER</pre></div>

<h4>
<a id="start-all-paused--stopped-containers" class="anchor" href="#start-all-paused--stopped-containers" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Start all paused / stopped containers</h4>

<ul>
<li>does not work together with container dependencies</li>
</ul>

<h4>
<a id="remove-all-containers-and-images" class="anchor" href="#remove-all-containers-and-images" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Remove all containers and images</h4>

<div class="highlight highlight-source-shell"><pre>docker stop <span class="pl-s"><span class="pl-pds">$(</span>docker ps -q<span class="pl-pds">)</span></span> <span class="pl-k">&amp;&amp;</span> docker rm <span class="pl-s"><span class="pl-pds">$(</span>docker ps -qa<span class="pl-pds">)</span></span> <span class="pl-k">&amp;&amp;</span> docker rmi <span class="pl-s"><span class="pl-pds">$(</span>docker images -qa<span class="pl-pds">)</span></span></pre></div>

<h4>
<a id="edit-and-update-a-file-in-a-container" class="anchor" href="#edit-and-update-a-file-in-a-container" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Edit and update a file in a container</h4>

<div class="highlight highlight-source-shell"><pre>docker cp CONTAINER:FILE /tmp/ <span class="pl-k">&amp;&amp;</span> docker run --name=nano -it --rm -v /tmp:/tmp \
 piegsaj/nano nano /tmp/FILE <span class="pl-k">;</span> \
cat /tmp/FILE <span class="pl-k">|</span> docker <span class="pl-c1">exec</span> -i CONTAINER sh -c <span class="pl-s"><span class="pl-pds">'</span>cat &gt; FILE<span class="pl-pds">'</span></span> <span class="pl-k">;</span> \
rm /tmp/FILE</pre></div>

<h4>
<a id="deploy-war-file-to-apache-tomcat-server-instantly" class="anchor" href="#deploy-war-file-to-apache-tomcat-server-instantly" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Deploy war file to Apache Tomcat server instantly</h4>

<div class="highlight highlight-source-shell"><pre>docker run -i -t -p 80:8080 -e WAR_URL=“<span class="pl-k">&lt;</span>http://web-actions.googlecode.com/files/helloworld.war<span class="pl-k">&gt;</span>” \
 bbytes/tomcat7</pre></div>

<h4>
<a id="dump-a-postgres-database-into-current-directory-on-the-host" class="anchor" href="#dump-a-postgres-database-into-current-directory-on-the-host" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Dump a Postgres database into current directory on the host</h4>

<div class="highlight highlight-source-shell"><pre><span class="pl-c1">echo</span> <span class="pl-s"><span class="pl-pds">"</span>postgres_password<span class="pl-pds">"</span></span> <span class="pl-k">|</span> sudo docker run -i --rm --link db:db -v <span class="pl-smi">$PWD</span>:/tmp postgres:8 sh -c <span class="pl-s"><span class="pl-pds">'</span> \</span>
<span class="pl-s"> pg_dump -h ocdb -p $OCDB_PORT_5432_TCP_PORT -U postgres -F tar -v openclinica \</span>
<span class="pl-s"> &gt; /tmp/ocdb_pg_dump_$(date +%Y-%m-%d_%H-%M-%S).tar<span class="pl-pds">'</span></span></pre></div>

<h4>
<a id="backup-data-folder" class="anchor" href="#backup-data-folder" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Backup data folder</h4>

<div class="highlight highlight-source-shell"><pre>docker run --rm --volumes-from oc-data -v <span class="pl-smi">$PWD</span>:/tmp piegsaj/openclinica \
 tar cvf /tmp/oc_data_backup_<span class="pl-s"><span class="pl-pds">$(</span>date +%Y-%m-%d_%H-%M-%S<span class="pl-pds">)</span></span>.tar /tomcat/openclinica.data</pre></div>

<h4>
<a id="restore-volume-from-data-only-container" class="anchor" href="#restore-volume-from-data-only-container" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Restore volume from data-only container</h4>

<div class="highlight highlight-source-shell"><pre>docker run --rm --volumes-from oc-data2 -v <span class="pl-smi">$pwd</span>:/tmp piegsaj/openclinica \
 tar xvf /tmp/oc_data_backup_<span class="pl-k">*</span>.tar</pre></div>

<h4>
<a id="get-the-ip-address-of-a-container" class="anchor" href="#get-the-ip-address-of-a-container" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Get the IP address of a container</h4>

<div class="highlight highlight-source-shell"><pre>docker inspect container_id <span class="pl-k">|</span> grep IPAddress <span class="pl-k">|</span> cut -d <span class="pl-s"><span class="pl-pds">'</span>"<span class="pl-pds">'</span></span> -f 4</pre></div>

<h2>
<a id="213-using-volumes" class="anchor" href="#213-using-volumes" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>2.1.3. Using Volumes</h2>

<h4>
<a id="declare-a-volume-via-dockerfile" class="anchor" href="#declare-a-volume-via-dockerfile" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Declare a volume via Dockerfile</h4>

<pre><code>RUN mkdir /data &amp;&amp; echo "some content" &gt; /data/file &amp;&amp; chown -R daemon:daemon /data
VOLUME /data
</code></pre>

<ul>
<li><em>note: after the <code>VOLUME</code> directive, its content can not be changed within the Dockerfile</em></li>
</ul>

<h4>
<a id="create-a-volume-at-runtime" class="anchor" href="#create-a-volume-at-runtime" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Create a volume at runtime</h4>

<div class="highlight highlight-source-shell"><pre>docker run -it -v /data debian /bin/bash</pre></div>

<h4>
<a id="create-a-volume-at-runtime-bound-to-a-host-directory" class="anchor" href="#create-a-volume-at-runtime-bound-to-a-host-directory" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Create a volume at runtime bound to a host directory</h4>

<div class="highlight highlight-source-shell"><pre>docker run --rm -v /tmp:/data debian ls -RAlph /data</pre></div>

<h4>
<a id="create-a-named-volume-and-use-it" class="anchor" href="#create-a-named-volume-and-use-it" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Create a named volume and use it</h4>

<div class="highlight highlight-source-shell"><pre>docker volume create --name=<span class="pl-c1">test</span>
docker run --rm -v <span class="pl-c1">test</span>:/data alpine sh -c <span class="pl-s"><span class="pl-pds">'</span>echo "Hello named volumes" &gt; /data/hello.txt<span class="pl-pds">'</span></span>
docker run --rm -v <span class="pl-c1">test</span>:/data alpine sh -c <span class="pl-s"><span class="pl-pds">'</span>cat /data/hello.txt<span class="pl-pds">'</span></span></pre></div>

<h4>
<a id="list-the-content-of-a-volume" class="anchor" href="#list-the-content-of-a-volume" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>List the content of a volume</h4>

<div class="highlight highlight-source-shell"><pre>docker run --rm -v data:/data alpine ls -RAlph /data</pre></div>

<h4>
<a id="copy-a-file-from-host-to-named-volume" class="anchor" href="#copy-a-file-from-host-to-named-volume" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Copy a file from host to named volume</h4>

<div class="highlight highlight-source-shell"><pre><span class="pl-c1">echo</span> <span class="pl-s"><span class="pl-pds">"</span>debug=true<span class="pl-pds">"</span></span> <span class="pl-k">&gt;</span> <span class="pl-c1">test</span>.cnf <span class="pl-k">&amp;&amp;</span> \
docker volume create --name=conf <span class="pl-k">&amp;&amp;</span> \
docker run --rm -it -v <span class="pl-s"><span class="pl-pds">$(</span><span class="pl-c1">pwd</span><span class="pl-pds">)</span></span>:/src -v conf:/dest alpine cp /src/test.cnf /dest/ <span class="pl-k">&amp;&amp;</span> \
rm -f <span class="pl-c1">test</span>.cnf <span class="pl-k">&amp;&amp;</span> \
docker run --rm -it -v conf:/data alpine cat /data/test.cnf</pre></div>

<h4>
<a id="copy-content-of-existing-named-volume-to-a-new-named-volume" class="anchor" href="#copy-content-of-existing-named-volume-to-a-new-named-volume" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Copy content of existing named volume to a new named volume</h4>

<div class="highlight highlight-source-shell"><pre>docker volume create --name vol_b
docker run --rm -v vol_a:/source/folder -v vol_b:/target/folder -it \
 rawmind/alpine-base:0.3.4 cp -r /source/folder /target</pre></div>

<h4>
<a id="remove-unused-images" class="anchor" href="#remove-unused-images" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Remove unused images</h4>

<div class="highlight highlight-source-shell"><pre>docker volume rm <span class="pl-s"><span class="pl-pds">$(</span>docker volume ls -qf dangling=<span class="pl-c1">true</span><span class="pl-pds">)</span></span></pre></div>

<h2>
<a id="22-docker-machine" class="anchor" href="#22-docker-machine" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>2.2. Docker Machine</h2>

<h3>
<a id="on-a-local-vm" class="anchor" href="#on-a-local-vm" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>On a local VM</h3>

<h4>
<a id="get-the-ip-address-of-the-virtual-machine-for-access-from-host" class="anchor" href="#get-the-ip-address-of-the-virtual-machine-for-access-from-host" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Get the IP address of the virtual machine for access from host</h4>

<pre><code>docker-machine ip default
</code></pre>

<h4>
<a id="add-persistent-environment-variable-to-boot2docker" class="anchor" href="#add-persistent-environment-variable-to-boot2docker" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Add persistent environment variable to boot2docker</h4>

<div class="highlight highlight-source-shell"><pre>sudo <span class="pl-c1">echo</span> <span class="pl-s"><span class="pl-pds">'</span>echo <span class="pl-pds">'</span></span><span class="pl-cce">\'</span><span class="pl-s"><span class="pl-pds">'</span>export ENVTEST="Hello Env!"<span class="pl-pds">'</span></span><span class="pl-cce">\'</span><span class="pl-s"><span class="pl-pds">'</span> &gt; /etc/profile.d/custom.sh<span class="pl-pds">'</span></span> <span class="pl-k">|</span> \
sudo tee -a /var/lib/boot2docker/profile <span class="pl-k">&gt;</span> /dev/null</pre></div>

<p>and restart with <code>docker-machine restart default</code></p>

<h4>
<a id="install-additional-linux-packages-in-boot2docker" class="anchor" href="#install-additional-linux-packages-in-boot2docker" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Install additional linux packages in boot2docker</h4>

<ul>
<li>create the file <code>/var/lib/boot2docker/bootsync.sh</code> with a content like:</li>
</ul>

<div class="highlight highlight-source-shell"><pre><span class="pl-c">#!/bin/sh</span>
sudo /bin/su - docker -c <span class="pl-s"><span class="pl-pds">'</span>tce-load -wi nano<span class="pl-pds">'</span></span></pre></div>

<h4>
<a id="recreate-any-folders-and-files-on-boot2docker-startup" class="anchor" href="#recreate-any-folders-and-files-on-boot2docker-startup" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Recreate any folders and files on boot2docker startup</h4>

<ul>
<li>store folders / files in <code>/var/lib/boot2docker/restore-on-boot</code> and</li>
<li>create the file <code>/var/lib/boot2docker/bootsync.sh</code> with a content like:</li>
</ul>

<div class="highlight highlight-source-shell"><pre><span class="pl-c">#!/bin/sh</span>
sudo mkdir -p /var/lib/boot2docker/restore-on-boot <span class="pl-k">&amp;&amp;</span> \
sudo rsync -a /var/lib/boot2docker/restore-on-boot/ /</pre></div>

<h2>
<a id="23-dockerfile" class="anchor" href="#23-dockerfile" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>2.3. Dockerfile</h2>

<h4>
<a id="add-a-periodic-health-check" class="anchor" href="#add-a-periodic-health-check" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Add a periodic health check</h4>

<pre><code>HEALTHCHECK --interval=1m --timeout=3s --retries=5 \
 CMD curl -f &lt;http://localhost/&gt; || exit 1
</code></pre>

<ul>
<li>see also: <a href="https://docs.docker.com/engine/reference/builder/#/healthcheck">HEALTHCHECK</a>
</li>
</ul>

<h1>
<a id="3-showcases" class="anchor" href="#3-showcases" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>3. Showcases</h1>

<h2>
<a id="31-private-docker-registry" class="anchor" href="#31-private-docker-registry" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>3.1. Private Docker Registry</h2>

<h4>
<a id="setup-with-docker-machine--boot2docker" class="anchor" href="#setup-with-docker-machine--boot2docker" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Setup with docker-machine / boot2docker</h4>

<div class="highlight highlight-source-shell"><pre>docker pull registry:2.5.1 <span class="pl-k">;</span> \

<span class="pl-c"># Prepare registry-cert volume</span>
docker volume create --name=registry-cert <span class="pl-k">&amp;&amp;</span> \
sudo mkdir -p /var/lib/boot2docker/certs/ <span class="pl-k">&amp;&amp;</span> <span class="pl-c1">cd</span> /var/lib/boot2docker/ <span class="pl-k">&amp;&amp;</span> \
sudo openssl genrsa -out registry.key 4096 <span class="pl-k">&amp;&amp;</span> \
sudo openssl req -new -nodes -sha256 -subj <span class="pl-s"><span class="pl-pds">'</span>/CN=localhost<span class="pl-pds">'</span></span> -key registry.key -out registry.csr <span class="pl-k">&amp;&amp;</span> \
sudo openssl x509 -req -days 3650 -signkey registry.key -in registry.csr -out certs/registry.pem <span class="pl-k">&amp;&amp;</span> \
docker run --rm -it -v /var/lib/boot2docker/:/b2d -v registry-cert:/certs --entrypoint sh registry \
 -c <span class="pl-s"><span class="pl-pds">'</span>cp /b2d/registry.key /certs/ &amp;&amp; cp /b2d/certs/registry.pem /certs<span class="pl-pds">'</span></span> <span class="pl-k">&amp;&amp;</span> \

<span class="pl-c"># Prepare registry-auth volume (please change 'reg_user' and 'reg_password')</span>
docker volume create --name=registry-auth <span class="pl-k">&amp;&amp;</span> \
docker run --rm --entrypoint /bin/sh -v registry-auth:/auth registry \
 -c <span class="pl-s"><span class="pl-pds">'</span>htpasswd -Bbn reg_user reg_password &gt; /auth/htpasswd<span class="pl-pds">'</span></span> <span class="pl-k">&amp;&amp;</span> \

<span class="pl-c"># Prepare registry-data volume</span>
docker volume create --name=registry-data <span class="pl-k">&amp;&amp;</span> \

<span class="pl-c"># Stop and remove existing container</span>
{ docker stop registry <span class="pl-k">;</span> docker rm registry <span class="pl-k">;</span> } <span class="pl-k">&gt;</span>/dev/null <span class="pl-k">2&gt;&amp;1</span> <span class="pl-k">;</span> \

<span class="pl-c"># Create container</span>
docker run --name registry -h registry -d -l <span class="pl-c1">type</span>=app <span class="pl-s"><span class="pl-pds">"</span><span class="pl-smi">$ADD_HOST</span><span class="pl-pds">"</span></span> \
-v registry-data:/var/lib/registry \
-v registry-auth:/auth \
-v registry-cert:/certs \
--restart=always \
-p 5000:5000 \
-e REGISTRY_HTTP_TLS_KEY=/certs/registry.key \
-e REGISTRY_HTTP_TLS_CERTIFICATE=/certs/registry.pem \
-e REGISTRY_AUTH=htpasswd \
-e <span class="pl-s"><span class="pl-pds">"</span>REGISTRY_AUTH_HTPASSWD_REALM=Registry Realm<span class="pl-pds">"</span></span> \
-e REGISTRY_AUTH_HTPASSWD_PATH=/auth/htpasswd \
-e REGISTRY_STORAGE_DELETE_ENABLED=<span class="pl-c1">true</span> \
registry</pre></div>

<h4>
<a id="usage-example" class="anchor" href="#usage-example" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Usage example</h4>

<div class="highlight highlight-source-shell"><pre>docker pull alpine:latest <span class="pl-k">&amp;&amp;</span> \
docker login -u reg_user -p reg_password localhost:5000 <span class="pl-k">&amp;&amp;</span> \
docker tag alpine:latest localhost:5000/alpine:private <span class="pl-k">&amp;&amp;</span> \
docker rmi alpine:latest <span class="pl-k">&amp;&amp;</span> \
docker push localhost:5000/alpine:private <span class="pl-k">&amp;&amp;</span> \
docker rmi -f localhost:5000/alpine:private <span class="pl-k">&amp;&amp;</span> \
docker pull localhost:5000/alpine:private <span class="pl-k">&amp;&amp;</span> \
docker <span class="pl-c1">logout</span> localhost:5000 <span class="pl-k">&amp;&amp;</span> \
docker images <span class="pl-k">|</span> grep alpine <span class="pl-k">&amp;&amp;</span> \
<span class="pl-c1">echo</span> <span class="pl-s"><span class="pl-pds">"</span>Deleting image from registry...<span class="pl-pds">"</span></span> <span class="pl-k">&amp;&amp;</span> \
curl -X DELETE -u reg_user:reg_password \
https://localhost:5000/v2/alpine/manifests/<span class="pl-s"><span class="pl-pds">$(</span>docker images --digests <span class="pl-k">|</span> grep localhost:5000/alpine <span class="pl-k">|</span> awk <span class="pl-s"><span class="pl-pds">'</span>{print $3}<span class="pl-pds">'</span></span><span class="pl-pds">)</span></span></pre></div>

<h4>
<a id="removal" class="anchor" href="#removal" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Removal</h4>

<div class="highlight highlight-source-shell"><pre>docker rm -f registry <span class="pl-k">&amp;&amp;</span> \
docker volume rm registry-data registry-cert registry-auth</pre></div>

<h2>
<a id="32-continuous-integration-tool-stack" class="anchor" href="#32-continuous-integration-tool-stack" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>3.2. Continuous Integration Tool Stack</h2>

<h4>
<a id="setup-with-docker-machine--boot2docker-1" class="anchor" href="#setup-with-docker-machine--boot2docker-1" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Setup with docker-machine / boot2docker</h4>

<ul>
<li><p>make a directory called <code>ci</code> in your home directory on your host system and change into it</p></li>
<li><p>create a file named <code>docker-compose.yml</code> with the following content:</p></li>
</ul>

<div class="highlight highlight-source-yaml"><pre><span class="pl-ent">version:</span> <span class="pl-s"><span class="pl-pds">'</span>2<span class="pl-pds">'</span></span>

<span class="pl-ent">services:</span>

  <span class="pl-ent">jenkins:</span>
    <span class="pl-ent">image:</span> <span class="pl-s">jenkins</span>
    <span class="pl-ent">ports:</span>
      - <span class="pl-s"><span class="pl-pds">"</span>8082:8082<span class="pl-pds">"</span></span>
      - <span class="pl-s"><span class="pl-pds">"</span>50000:50000<span class="pl-pds">"</span></span>
    <span class="pl-ent">restart:</span> <span class="pl-s">always</span>
    <span class="pl-ent">env_file:</span> <span class="pl-s">.env</span>
    <span class="pl-ent">environment:</span>
      - <span class="pl-s"><span class="pl-pds">"</span>JAVA_OPTS=-Dmail.smtp.starttls.enable=true -Dorg.apache.commons.jelly.tags.fmt.timeZone=Europe/Berlin<span class="pl-pds">"</span></span>
      - <span class="pl-s"><span class="pl-pds">"</span>JENKINS_OPTS=--httpPort=8082<span class="pl-pds">"</span></span>
    <span class="pl-ent">volumes:</span>
      - <span class="pl-s">jenkins_home:/var/jenkins_home</span>

  <span class="pl-ent">nexus:</span>
    <span class="pl-ent">image:</span> <span class="pl-s">sonatype/nexus3</span>
    <span class="pl-ent">ports:</span>
      - <span class="pl-s"><span class="pl-pds">"</span>8081:8081<span class="pl-pds">"</span></span>
    <span class="pl-ent">restart:</span> <span class="pl-s">always</span>
    <span class="pl-ent">env_file:</span> <span class="pl-s">.env</span>
    <span class="pl-ent">volumes:</span>
      - <span class="pl-s">nexus-data:/nexus-data</span>

  <span class="pl-ent">sonarqube:</span>
    <span class="pl-ent">image:</span> <span class="pl-s">sonarqube</span>
    <span class="pl-ent">ports:</span>
      - <span class="pl-s"><span class="pl-pds">"</span>9000:9000<span class="pl-pds">"</span></span>
    <span class="pl-ent">restart:</span> <span class="pl-s">always</span>
    <span class="pl-ent">env_file:</span>
      - <span class="pl-s">.env</span>
      - <span class="pl-s">sonarqube.env</span>
    <span class="pl-ent">environment:</span>
      - <span class="pl-s">SONARQUBE_JDBC_URL=jdbc:postgresql://postgres:5432/sonar</span>
      - <span class="pl-s">SONARQUBE_JDBC_USERNAME=sonar</span>
    <span class="pl-ent">volumes:</span>
      - <span class="pl-s">sonarqube_conf:/opt/sonarqube/conf</span>
      - <span class="pl-s">sonarqube_data:/opt/sonarqube/data</span>
      - <span class="pl-s">sonarqube_extensions:/opt/sonarqube/extensions</span>
      - <span class="pl-s">sonarqube_bundled-plugins:/opt/sonarqube/lib/bundled-plugins</span>
    <span class="pl-ent">links:</span>
      - <span class="pl-s">postgres</span>

  <span class="pl-ent">postgres:</span>
    <span class="pl-ent">image:</span> <span class="pl-s">postgres</span>
    <span class="pl-ent">ports:</span>
      - <span class="pl-s"><span class="pl-pds">"</span>5432:5432<span class="pl-pds">"</span></span>
    <span class="pl-ent">restart:</span> <span class="pl-s">always</span>
    <span class="pl-ent">env_file:</span>
      - <span class="pl-s">.env</span>
      - <span class="pl-s">sonarqube.env</span>
    <span class="pl-ent">environment:</span>
      - <span class="pl-s">POSTGRES_USER=sonar</span>
    <span class="pl-ent">volumes:</span>
      - <span class="pl-s">postgresql:/var/lib/postgresql</span>
      - <span class="pl-s">postgresql_data:/var/lib/postgresql/data</span>

<span class="pl-ent">volumes:</span>
  <span class="pl-ent">jenkins_home:</span>
  <span class="pl-ent">nexus-data:</span>
  <span class="pl-ent">sonarqube_conf:</span>
  <span class="pl-ent">sonarqube_data:</span>
  <span class="pl-ent">sonarqube_extensions:</span>
  <span class="pl-ent">sonarqube_bundled-plugins:</span>
  <span class="pl-ent">postgresql:</span>
  <span class="pl-ent">postgresql_data:</span></pre></div>

<ul>
<li>create a second file named <code>.env</code> that defines a timezone:</li>
</ul>

<pre><code>TZ=Europe/Berlin
</code></pre>

<ul>
<li>create a third file named <code>sonarqube.env</code> that holds the database passwords:</li>
</ul>

<pre><code>SONARQUBE_JDBC_PASSWORD=sonar
POSTGRES_PASSWORD=sonar
</code></pre>

<h4>
<a id="usage" class="anchor" href="#usage" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Usage</h4>

<ul>
<li>startup all containers:</li>
</ul>

<pre><code>docker-compose up -d
</code></pre>

<ul>
<li><p>watch the logs, type <code>docker-compose logs</code> or <code>docker logs -f ci_jenkins_1</code></p></li>
<li>
<p>access the web applications:</p>

<ul>
<li>Jenkins on port 8082</li>
<li>Sonatype Nexus on port 8081 and</li>
<li>SonarQube on port 9000</li>
</ul>
</li>
</ul>

<h4>
<a id="removal-1" class="anchor" href="#removal-1" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Removal</h4>

<ul>
<li>to remove the tool stack (incl. data), use:</li>
</ul>

<pre><code>docker-compose stop &amp;&amp; docker-compose rm -fav
</code></pre>

<h1>
<a id="4-best-practices" class="anchor" href="#4-best-practices" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>4. Best Practices</h1>

<h2>
<a id="docker-engine" class="anchor" href="#docker-engine" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Docker Engine</h2>

<ul>
<li>
<code>docker exec</code> is your friend in development, but should be avoided in a production setup</li>
</ul>

<h2>
<a id="volumes" class="anchor" href="#volumes" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Volumes</h2>

<ul>
<li>use <em>named volumes</em> to simplify maintenance by separating persistent data from the container and communicating the structure of a project in a more transparent manner</li>
</ul>

<h2>
<a id="dockerfile" class="anchor" href="#dockerfile" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Dockerfile</h2>

<ul>
<li>always set the <code>USER</code> statement, otherwise the container will run as <code>root</code> user by default, which maps to the <code>root</code> user of the host machine</li>
<li>use <code>ENTRYPOINT</code> and <code>CMD</code> directives together to make container usage more convenient</li>
<li>combine consecutive <code>RUN</code> directives with <code>&amp;&amp;</code> to reduce the costs of a build and to avoid caching of instructions like <code>apt-get update</code>
</li>
<li>use <code>EXPOSE</code> to document all needed ports</li>
</ul>

<h1>
<a id="5-additional-material" class="anchor" href="#5-additional-material" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>5. Additional Material</h1>

<ul>
<li>
<a href="http://shop.oreilly.com/product/0636920035671.do">Mouat, A. (2015). <em>Using Docker: Developing and Deploying Software with Containers.</em> O'Reilly Media.</a> (<a href="https://www.dpunkt.de/buecher/12553/9783864903847-docker.html">German Edition: <em>Docker. Software entwickeln und deployen mit Containern.</em> dpunkt.verlag</a>)</li>
<li><a href="https://docs.docker.com/">Official Docker Documentation</a></li>
<li><a href="http://blog.arungupta.me/docker-container-anti-patterns/">Gupta, A. (2016). <em>Docker Container Anti Patterns.</em></a></li>
<li><a href="http://stackoverflow.com/documentation/docker/topics">StackOverflow Documentation</a></li>
</ul>

<hr>

<p>{{ site.github.project_title }}</p>

<p>{{ build_revision }}</p>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/JensPiegsa/docker-cheat-sheet">Docker Cheat Sheet</a> is maintained by <a href="https://github.com/JensPiegsa">JensPiegsa</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

  
  </body>
</html>
